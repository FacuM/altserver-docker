#!/bin/bash
# Self-diagnostic script for AltServer Docker setup
# Checks all prerequisites and provides actionable feedback

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}=========================================="
echo "  AltServer Docker - System Diagnostics"
echo -e "==========================================${NC}"
echo ""

ERRORS=0
WARNINGS=0

# Helper functions
check_pass() {
    echo -e "${GREEN}✓${NC} $1"
}

check_fail() {
    echo -e "${RED}✗${NC} $1"
    ((ERRORS++))
}

check_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARNINGS++))
}

section() {
    echo ""
    echo -e "${BLUE}▶ $1${NC}"
}

# ==========================================
# 1. Check Docker
# ==========================================
section "Docker"

if command -v docker &> /dev/null; then
    DOCKER_VERSION=$(docker --version 2>/dev/null | cut -d' ' -f3 | tr -d ',')
    check_pass "Docker installed (v$DOCKER_VERSION)"
else
    check_fail "Docker not installed"
    echo "       Run: ./scripts/setup-host to install"
fi

if docker info &> /dev/null; then
    check_pass "Docker daemon running"
else
    check_fail "Docker daemon not running or permission denied"
    echo "       Try: sudo systemctl start docker"
    echo "       Or add user to docker group: sudo usermod -aG docker \$USER"
fi

if command -v docker &> /dev/null && docker compose version &> /dev/null; then
    COMPOSE_VERSION=$(docker compose version 2>/dev/null | cut -d' ' -f4)
    check_pass "Docker Compose available (v$COMPOSE_VERSION)"
else
    check_fail "Docker Compose not available"
fi

# ==========================================
# 2. Check usbmuxd
# ==========================================
section "USB Multiplexer (usbmuxd)"

if command -v usbmuxd &> /dev/null; then
    check_pass "usbmuxd installed"
else
    check_fail "usbmuxd not installed"
    echo "       Run: ./scripts/setup-host to install"
fi

if pgrep -x usbmuxd > /dev/null; then
    check_pass "usbmuxd daemon running"
else
    check_fail "usbmuxd daemon NOT running"
    echo "       Start it with: sudo usbmuxd"
    echo "       Or: sudo systemctl start usbmuxd"
fi

if [ -S /var/run/usbmuxd ]; then
    check_pass "usbmuxd socket exists (/var/run/usbmuxd)"
elif [ -d /var/run/usbmuxd ]; then
    check_fail "/var/run/usbmuxd is a DIRECTORY (should be a socket file)"
    echo "       This happens when Docker creates the mount before usbmuxd runs."
    echo "       Fix: sudo rm -rf /var/run/usbmuxd && sudo usbmuxd"
    echo "       Then restart containers: docker compose down && docker compose up -d"
else
    check_fail "usbmuxd socket missing"
    echo "       Start usbmuxd: sudo usbmuxd"
fi

# ==========================================
# 3. Check libimobiledevice tools
# ==========================================
section "libimobiledevice Tools"

if command -v idevice_id &> /dev/null; then
    check_pass "libimobiledevice-utils installed"
else
    check_warn "libimobiledevice-utils not installed (optional on host)"
    echo "       Install for local device testing: sudo apt install libimobiledevice-utils"
fi

# ==========================================
# 4. Check USB Device
# ==========================================
section "iOS Device Detection"

if command -v lsusb &> /dev/null; then
    APPLE_DEVICE=$(lsusb 2>/dev/null | grep -i "apple" || true)
    if [ -n "$APPLE_DEVICE" ]; then
        check_pass "Apple device detected via USB:"
        echo "       $APPLE_DEVICE"
    else
        echo -e "${YELLOW}○${NC} No Apple device connected via USB (connect to pair)"
    fi
else
    check_warn "lsusb not available - cannot check USB devices"
fi

# Check if device is detected by libimobiledevice
if command -v idevice_id &> /dev/null && pgrep -x usbmuxd > /dev/null; then
    DEVICE_UDID=$(idevice_id -l 2>/dev/null || true)
    if [ -n "$DEVICE_UDID" ]; then
        check_pass "Device detected by libimobiledevice:"
        echo "       UDID: $DEVICE_UDID"
    else
        echo -e "${YELLOW}○${NC} No device detected by libimobiledevice (connect device to pair)"
    fi
fi

# ==========================================
# 5. Check Container Status
# ==========================================
section "Container Status"

if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^altserver$"; then
    check_pass "altserver container is running"
    
    # Check if device is visible inside container (only if device is connected on host)
    if [ -n "$APPLE_DEVICE" ]; then
        CONTAINER_DEVICE=$(docker exec altserver idevice_id -l 2>/dev/null || true)
        if [ -n "$CONTAINER_DEVICE" ]; then
            check_pass "Device visible inside container: $CONTAINER_DEVICE"
        else
            check_warn "Device NOT visible inside container"
            echo "       Restart container after starting usbmuxd:"
            echo "       docker compose down && docker compose up -d"
        fi
    fi
else
    check_warn "altserver container is not running"
    echo "       Start with: docker compose up -d"
fi

if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^anisette"; then
    check_pass "anisette container is running"
else
    check_warn "anisette container is not running"
fi

# ==========================================
# 6. Check Network
# ==========================================
section "Network Configuration"

# Check if port 6969 is accessible (anisette)
if curl -s --connect-timeout 2 http://127.0.0.1:6969 > /dev/null 2>&1; then
    check_pass "Anisette server accessible on port 6969"
else
    check_warn "Anisette server not responding on port 6969"
fi

# ==========================================
# Summary
# ==========================================
echo ""
echo -e "${BLUE}=========================================="
echo "  Summary"
echo -e "==========================================${NC}"
echo ""

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}✓ All checks passed! System is ready.${NC}"
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}⚠ $WARNINGS warning(s) found. System may work but check above.${NC}"
else
    echo -e "${RED}✗ $ERRORS error(s) and $WARNINGS warning(s) found.${NC}"
    echo ""
    echo "Run ./scripts/setup-host to install missing dependencies."
fi

echo ""
exit $ERRORS
