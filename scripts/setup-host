#!/bin/bash
# Host setup script for AltServer Docker
# Installs required dependencies on popular Linux distributions

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}=========================================="
echo "  AltServer Docker - Host Setup"
echo -e "==========================================${NC}"
echo ""

# Detect distribution
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
        DISTRO_LIKE=$ID_LIKE
        VERSION=$VERSION_ID
    elif [ -f /etc/lsb-release ]; then
        . /etc/lsb-release
        DISTRO=$DISTRIB_ID
        VERSION=$DISTRIB_RELEASE
    elif [ -f /etc/debian_version ]; then
        DISTRO="debian"
        VERSION=$(cat /etc/debian_version)
    elif [ -f /etc/fedora-release ]; then
        DISTRO="fedora"
    elif [ -f /etc/arch-release ]; then
        DISTRO="arch"
    else
        DISTRO="unknown"
    fi
    
    DISTRO=$(echo "$DISTRO" | tr '[:upper:]' '[:lower:]')
}

# Check if running as root or with sudo
check_sudo() {
    if [ "$EUID" -ne 0 ]; then
        if command -v sudo &> /dev/null; then
            SUDO="sudo"
        else
            echo -e "${RED}Error: This script requires root privileges.${NC}"
            echo "Please run as root or install sudo."
            exit 1
        fi
    else
        SUDO=""
    fi
}

# Install packages based on distribution
install_packages() {
    local packages="$1"
    
    case "$DISTRO" in
        ubuntu|debian|linuxmint|pop|elementary|zorin)
            echo -e "${BLUE}▶ Updating package lists...${NC}"
            $SUDO apt-get update
            echo -e "${BLUE}▶ Installing packages: $packages${NC}"
            $SUDO apt-get install -y $packages
            ;;
        fedora)
            echo -e "${BLUE}▶ Installing packages: $packages${NC}"
            $SUDO dnf install -y $packages
            ;;
        centos|rhel|rocky|almalinux)
            echo -e "${BLUE}▶ Installing packages: $packages${NC}"
            $SUDO yum install -y $packages
            ;;
        arch|manjaro|endeavouros)
            echo -e "${BLUE}▶ Installing packages: $packages${NC}"
            $SUDO pacman -S --noconfirm $packages
            ;;
        opensuse*|suse|sles)
            echo -e "${BLUE}▶ Installing packages: $packages${NC}"
            $SUDO zypper install -y $packages
            ;;
        *)
            # Try to detect based on ID_LIKE
            if echo "$DISTRO_LIKE" | grep -q "debian\|ubuntu"; then
                $SUDO apt-get update && $SUDO apt-get install -y $packages
            elif echo "$DISTRO_LIKE" | grep -q "fedora\|rhel"; then
                $SUDO dnf install -y $packages || $SUDO yum install -y $packages
            elif echo "$DISTRO_LIKE" | grep -q "arch"; then
                $SUDO pacman -S --noconfirm $packages
            else
                echo -e "${RED}Unsupported distribution: $DISTRO${NC}"
                echo "Please install manually: $packages"
                return 1
            fi
            ;;
    esac
}

# Get package names for the distribution
get_package_names() {
    case "$DISTRO" in
        ubuntu|debian|linuxmint|pop|elementary|zorin)
            DOCKER_PKGS="docker.io docker-compose-v2"
            USBMUXD_PKGS="usbmuxd libimobiledevice-utils"
            UTILS_PKGS="usbutils curl"
            ;;
        fedora)
            DOCKER_PKGS="docker docker-compose"
            USBMUXD_PKGS="usbmuxd libimobiledevice-utils"
            UTILS_PKGS="usbutils curl"
            ;;
        centos|rhel|rocky|almalinux)
            DOCKER_PKGS="docker docker-compose"
            USBMUXD_PKGS="usbmuxd libimobiledevice-utils"
            UTILS_PKGS="usbutils curl"
            ;;
        arch|manjaro|endeavouros)
            DOCKER_PKGS="docker docker-compose"
            USBMUXD_PKGS="usbmuxd libimobiledevice"
            UTILS_PKGS="usbutils curl"
            ;;
        opensuse*|suse|sles)
            DOCKER_PKGS="docker docker-compose"
            USBMUXD_PKGS="usbmuxd libimobiledevice-tools"
            UTILS_PKGS="usbutils curl"
            ;;
        *)
            # Fallback - most common names
            DOCKER_PKGS="docker docker-compose"
            USBMUXD_PKGS="usbmuxd libimobiledevice-utils"
            UTILS_PKGS="usbutils curl"
            ;;
    esac
}

# Install Docker using official method for specific distros
install_docker_official() {
    echo -e "${BLUE}▶ Installing Docker using official method...${NC}"
    
    case "$DISTRO" in
        ubuntu|debian)
            # Install prerequisites
            $SUDO apt-get update
            $SUDO apt-get install -y ca-certificates curl gnupg
            
            # Add Docker's official GPG key
            $SUDO install -m 0755 -d /etc/apt/keyrings
            curl -fsSL "https://download.docker.com/linux/$DISTRO/gpg" | $SUDO gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            $SUDO chmod a+r /etc/apt/keyrings/docker.gpg
            
            # Add the repository
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$DISTRO \
              $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
              $SUDO tee /etc/apt/sources.list.d/docker.list > /dev/null
            
            # Install Docker
            $SUDO apt-get update
            $SUDO apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            ;;
        fedora)
            $SUDO dnf -y install dnf-plugins-core
            $SUDO dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
            $SUDO dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            ;;
        *)
            # Fallback to distribution packages
            install_packages "$DOCKER_PKGS"
            ;;
    esac
}

# Configure usbmuxd service
configure_usbmuxd() {
    echo -e "${BLUE}▶ Configuring usbmuxd...${NC}"
    
    # Enable and start usbmuxd service
    if command -v systemctl &> /dev/null; then
        $SUDO systemctl enable usbmuxd 2>/dev/null || true
        $SUDO systemctl start usbmuxd 2>/dev/null || $SUDO usbmuxd
    else
        # Fallback for systems without systemd
        $SUDO usbmuxd 2>/dev/null || true
    fi
    
    # Verify socket was created
    sleep 2
    if [ -S /var/run/usbmuxd ]; then
        echo -e "${GREEN}✓ usbmuxd socket created successfully${NC}"
    elif [ -d /var/run/usbmuxd ]; then
        echo -e "${YELLOW}⚠ /var/run/usbmuxd is a directory, fixing...${NC}"
        $SUDO rm -rf /var/run/usbmuxd
        $SUDO usbmuxd
        sleep 1
        if [ -S /var/run/usbmuxd ]; then
            echo -e "${GREEN}✓ Fixed! usbmuxd socket now exists${NC}"
        fi
    fi
}

# Add current user to docker group
configure_docker_user() {
    if [ -n "$SUDO_USER" ]; then
        TARGET_USER="$SUDO_USER"
    elif [ -n "$USER" ] && [ "$USER" != "root" ]; then
        TARGET_USER="$USER"
    else
        return 0
    fi
    
    if getent group docker > /dev/null 2>&1; then
        if ! groups "$TARGET_USER" 2>/dev/null | grep -q docker; then
            echo -e "${BLUE}▶ Adding $TARGET_USER to docker group...${NC}"
            $SUDO usermod -aG docker "$TARGET_USER"
            echo -e "${YELLOW}⚠ Log out and back in for group changes to take effect${NC}"
        fi
    fi
}

# Main installation flow
main() {
    detect_distro
    check_sudo
    get_package_names
    
    echo -e "Detected distribution: ${GREEN}$DISTRO${NC}"
    [ -n "$VERSION" ] && echo -e "Version: ${GREEN}$VERSION${NC}"
    echo ""
    
    # Ask what to install
    echo "What would you like to install?"
    echo ""
    echo "  1) Everything (recommended)"
    echo "  2) Docker only"
    echo "  3) usbmuxd and libimobiledevice only"
    echo "  4) Exit"
    echo ""
    read -p "Select option [1-4]: " choice
    
    case "$choice" in
        1)
            echo ""
            # Install utilities first
            install_packages "$UTILS_PKGS"
            
            # Install Docker
            if ! command -v docker &> /dev/null; then
                install_docker_official
            else
                echo -e "${GREEN}✓ Docker already installed${NC}"
            fi
            
            # Start and enable Docker
            if command -v systemctl &> /dev/null; then
                $SUDO systemctl enable docker 2>/dev/null || true
                $SUDO systemctl start docker 2>/dev/null || true
            fi
            
            # Install usbmuxd
            install_packages "$USBMUXD_PKGS"
            configure_usbmuxd
            
            # Configure user
            configure_docker_user
            ;;
        2)
            echo ""
            if ! command -v docker &> /dev/null; then
                install_docker_official
                if command -v systemctl &> /dev/null; then
                    $SUDO systemctl enable docker 2>/dev/null || true
                    $SUDO systemctl start docker 2>/dev/null || true
                fi
                configure_docker_user
            else
                echo -e "${GREEN}✓ Docker already installed${NC}"
            fi
            ;;
        3)
            echo ""
            install_packages "$USBMUXD_PKGS"
            configure_usbmuxd
            ;;
        4)
            echo "Exiting."
            exit 0
            ;;
        *)
            echo -e "${RED}Invalid option${NC}"
            exit 1
            ;;
    esac
    
    echo ""
    echo -e "${GREEN}=========================================="
    echo "  Setup Complete!"
    echo -e "==========================================${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Run ./scripts/diagnose to verify setup"
    echo "  2. Connect your iOS device via USB"
    echo "  3. Run: docker compose up -d"
    echo "  4. Run: docker exec -it altserver pair"
    echo ""
    
    if [ "$choice" = "1" ] || [ "$choice" = "2" ]; then
        if ! docker info &> /dev/null; then
            echo -e "${YELLOW}Note: Log out and back in for Docker permissions to take effect.${NC}"
            echo ""
        fi
    fi
}

main "$@"
